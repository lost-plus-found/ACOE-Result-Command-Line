#!/bin/bash

if [ "$1" = "-n" ]; then
	echo ""
	echo -n "Register Number: "
	read REGISTER
	echo -n "Password: "
	read -s P
	echo
	PASSWORD=`echo -n $P | openssl dgst -sha512`
	LEN=`expr ${#PASSWORD} - 9`
	PASSWORD=${PASSWORD:9:$LEN}
else
	REGISTER="XXXXXX"
	PASSWORD="YYYYYY"
fi

if [ "$REGISTER" = "XXXXXX" ]; then
	echo "Hey, Please install properly to stop seeing this message! Execute the following Command"
	echo "cd ~/ACOE-Result-Command-Line && sudo make install"
	echo
	echo "To check the result manually, execute the following command"
	echo "auresult -n"
fi

if curl -s --connect-timeout 10 --data "user=$R&password=&p=$P" https://acoe.annauniv.edu/student/process_login.php > /dev/null; then
        echo "Server is fine!"
else
        echo "Server is not responding, Please try after sometime"
        exit 0
fi

echo "Please be patient..."

curl -c .c0.txt -s --data "user=$REGISTER&password=&p=$PASSWORD" https://acoe.annauniv.edu/student/process_login.php
curl -s -b .c0.txt https://acoe.annauniv.edu/student/result.php > .temp
echo 
echo '
from bs4 import BeautifulSoup
from prettytable import PrettyTable

page = open("./.temp", "r").read()
soup = BeautifulSoup(page, "html.parser")
results = soup.findAll("table")

res = ["REGULAR", "ARREAR", "REVALUATION"]
i = 0
for result in results:
        if result.findParent("table") is None:
                print "\t\t\t\t%s" % res[i]
                t = PrettyTable(["Subject Code", "Subject Name", "Grade"])
                for tr in result.find_all("tr")[1:]:
                        tds = tr.find_all("td")
                        t.add_row([tds[0].text, tds[1].text, tds[2].text])
                print t
                print "\n"
                i+=1
' > .display.py
python .display.py

echo "Enter 1 to download Regular Result; 2 to download Arrear Result; 3 to download Revaluation Result; any other to exit"
echo -n "> "
read pdfchoice

if [ "$pdfchoice" = "1" ]; then
	pdfname="_Regular_Result.pdf"
	curl -s -o "$REGISTER$pdfname" -b .c0.txt https://acoe.annauniv.edu/student/result_print.php
	echo "Downloaded as $REGISTER$pdfname"
elif [ "$pdfchoice" = "2" ]; then
	pdfname="_Arrear_Result.pdf"
        curl -s -o "$REGISTER$pdfname" -b .c0.txt https://acoe.annauniv.edu/student/arr_print.php
	echo "Downloaded as $REGISTER$pdfname"
elif [ "$pdfchoice" = "3" ]; then
	pdfname="_Reval_Result.pdf"
        curl -s -o "$REGISTER$pdfname" -b .c0.txt https://acoe.annauniv.edu/student/reval_print.php
	echo "Downloaded as $REGISTER$pdfname"
else
	echo 'exiting'
fi
rm .display.py .c0.txt .temp
